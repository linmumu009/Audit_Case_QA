# Audit_Case_QA

è¯¥é¡¹ç›®æ˜¯ç”¨langgraphæ­å»ºä¸€ä¸ªå®¡è®¡æ¡ˆä¾‹é—®ç­”æœºå™¨äººï¼Œä»¥æ»¡è¶³é’ˆå¯¹ç”¨æˆ·æƒé™ä¸‹çš„æ¡ˆä¾‹æŸ¥è¯¢å’Œåˆ†æéœ€æ±‚ã€‚

ğŸŸ¦ åŸºç¡€ç¯å¢ƒï¼špython = 3.10
ğŸŸ¨ çŸ¥è¯†åº“ï¼šElasticSearch = 9.2.2
ğŸŸ© Agentæ¡†æ¶ï¼šlanggraph = 1.0.4

## å¿«é€Ÿæ‰§è¡Œ
1. è·å–æœ¯è¯­å­—å…¸ï¼š```python get_keywords_batch.py```
2. åˆæˆæ¡ˆä¾‹ï¼š```python ./make_case/es_write.py```
3. ESå…¥åº“ï¼š```python ./make_case/case_create.py```
4. æ­å»ºæ™ºèƒ½ä½“å¹¶è¿è¡Œï¼š```python ./Case_QA.py```

## 1 èƒŒæ™¯ç®€ä»‹
- ç›®å‰æœ‰ä¸€ä¸ªå®¡è®¡æ¡ˆä¾‹åº“ï¼Œå­˜æ”¾äº†æ¯ä¸ªç¼ºé™·æ¡ˆä¾‹å‘ç”Ÿçš„æ—¶é—´ã€æ¡ˆä¾‹å½’å±æœºæ„å’Œç¼ºé™·æ¡ˆä¾‹å†…å®¹
- ä½¿ç”¨äººå‘˜æ˜¯é›†å›¢å’Œå­å…¬å¸ã€åˆ†æ”¯æœºæ„çš„å®¡è®¡äººå‘˜ï¼Œæ¯ä¸ªäººå‘˜æœ‰è‡ªå·±çš„æƒé™ï¼Œä¾‹å¦‚é›†å›¢å¯ä»¥æŸ¥çœ‹å…¨éƒ¨æ¡ˆä¾‹ï¼ŒAçœaå¸‚çš„åªèƒ½çœ‹åˆ°å¯¹åº”çš„æ¡ˆä¾‹
- å¸Œæœ›å»ºç«‹ä¸€ä¸ªé—®ç­”æœºå™¨äººï¼Œèƒ½é€šè¿‡é—®ç­”ç•Œé¢å®Œæˆæ¡ˆä¾‹çš„æŸ¥è¯¢å’Œåˆ†æï¼Œå¹¶æ”¯æŒå¤šè½®é—®ç­”ã€‚
  
## 2 æœ¯è¯­å¤„ç†
- è€ƒè™‘åˆ°ä¸šåŠ¡æ•°æ®æ•æ„Ÿæ€§ï¼Œè¿™é‡Œç”¨äº†å¤§æ¨¡å‹åˆæˆçš„æŸ¥è¯¢ï¼Œè§```./data/ç”¨æˆ·æŸ¥è¯¢æŒ‡ä»¤é›†.xlsx```
- æ ¹æ®åˆ†æï¼Œæˆ‘ä»¬å‘ç°æŒ‡ä»¤ä¸­å­˜åœ¨å®¡è®¡ä¸“ä¸šæœ¯è¯­å’Œæ¨¡ç³Šè¡¨è¿°ï¼Œå¤§æ¨¡å‹åœ¨è¿™ä¸¤æ–¹é¢å›ç­”çš„ä¸å¥½ï¼Œå› æ­¤éœ€è¦é’ˆå¯¹æ€§æ„å»ºæœ¯è¯­è¯å…¸ã€‚
- åŸºäºä¸Šè¿°å†…å®¹ï¼Œè®©å¤§æ¨¡å‹è‡ªä¸»æŒ–æ˜æŒ‡ä»¤ä¸­çš„å®¡è®¡ä¸“ä¸šæœ¯è¯­å’Œæ¨¡ç³Šè¡¨è¿°ï¼Œç„¶åæ ¹æ®è¿™äº›å†…å®¹ç”Ÿæˆæœ¯è¯­å®šä¹‰ã€‚

æ‰§è¡Œå‘½ä»¤ç”Ÿæˆæœ¯è¯­ã€‚
```
python get_keywords_batch.py
```
å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š
- ä½¿ç”¨```pandas```è¯»å–ç”¨æˆ·æŸ¥è¯¢æŒ‡ä»¤

    | id   | é—®é¢˜	     | ç±»åˆ«     |
    | ---------- | ------------------------------------ | ------ |
    | 1 | äº§é™©è½¦é™©æ‰¿ä¿ç¯èŠ‚è¿‘å¹´æ¥æœ‰å“ªäº›è™šå¢ä¿è´¹ç›¸å…³çš„å…¸å‹å®¡è®¡å‘ç°ï¼Ÿ | è½¦é™©ç›¸å…³ |
    | 2 | è¿‘å¹´æ¥å¥åº·é™©æœªæŒ‰è§„å®šåˆ’åˆ†ä¿éšœè´£ä»»çš„å®¡è®¡å‘ç°æœ‰å“ªäº›åˆè§„é£é™©ï¼Ÿ | å¥åº·é™©ç›¸å…³ |
    | 3 | è¿‘å¹´æ¥å¯¿é™©ä¸šåŠ¡ç³»ç»Ÿä¸è´¢åŠ¡ç³»ç»Ÿä¿è´¹æ•°æ®ä¸ä¸€è‡´çš„å®¡è®¡å‘ç°ï¼Ÿ | å¯¿é™©ç›¸å…³ |
  
- è°ƒç”¨å¤§æ¨¡å‹ï¼ˆæˆ‘æ˜¯é˜¿é‡Œå…¬æœ‰äº‘çš„qwen-plusï¼‰ï¼Œåˆ†ææŒ‡ä»¤ä¸­çš„å®¡è®¡ä¸“ä¸šæœ¯è¯­å’Œæ¨¡ç³Šè¡¨è¿°ã€‚
    ```
    # è¿™é‡Œä¿®æ”¹å¤§æ¨¡å‹è°ƒç”¨çš„urlå’Œapi_key
    async def main():
        base_url = "your_base_url"
        api_key = "your_api_key"
    ```
- ä¿å­˜æˆè¯è¡¨ä¾›åç»­ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä¸“ä¸šæœ¯è¯­å’Œæ¨¡ç³Šè¯æ±‡åŠå¯¹åº”çš„å®šä¹‰ã€‚
  - é»˜è®¤ä¿å­˜åœ¨```"./output/terms_dict.json"```å’Œ```"./output/illdefined_dict.json"```
  - è¿™é‡Œä»…æ˜¯å¤§æ¨¡å‹è‡ªå·±çš„å®šä¹‰ï¼Œå®é™…éœ€è¦ä¸šåŠ¡ç¡®è®¤ã€‚
    ```
    {
        "é”€å”®é€‚å½“æ€§": "é”€å”®é€‚å½“æ€§æ˜¯æŒ‡é‡‘èæœºæ„åœ¨é”€å”®è¿‡ç¨‹ä¸­å¿…é¡»ç¡®ä¿å…¶äº§å“å’ŒæœåŠ¡ç¬¦åˆå®¢æˆ·çš„é£é™©æ‰¿å—èƒ½åŠ›å’Œå…¶ä»–ç›¸å…³æƒ…å†µã€‚",
        "å†…éƒ¨é—®è´£": "æŒ‡ä¼ä¸šå¯¹å‘˜å·¥æˆ–æœºæ„åœ¨ç»è¥ç®¡ç†è¿‡ç¨‹ä¸­è¿åæ³•å¾‹æ³•è§„ã€ç›‘ç®¡è§„å®šæˆ–å†…éƒ¨åˆ¶åº¦çš„è¡Œä¸ºï¼Œæ‰€é‡‡å–çš„å†…éƒ¨çºªå¾‹å¤„åˆ†ã€ç»æµå¤„ç½šæˆ–å…¶ä»–å¤„ç†æªæ–½ã€‚",
        "å†…å‹¤": "æŒ‡å¯¿é™©å…¬å¸å†…éƒ¨ä»äº‹ç®¡ç†ã€è¿è¥ã€æ”¯æŒç­‰èŒèƒ½çš„æ­£å¼å‘˜å·¥ï¼Œä¸ç›´æ¥å‚ä¸ä¿é™©é”€å”®ã€‚",
        "å¤–å‹¤": "æŒ‡å¯¿é™©å…¬å¸ä¸­ä»äº‹ä¿é™©äº§å“é”€å”®çš„ä»£ç†äººæˆ–è¥é”€äººå‘˜ï¼Œé€šå¸¸ä¸ºåˆåŒåˆ¶æˆ–ä»£ç†åˆ¶ï¼Œç›´æ¥é¢å‘å®¢æˆ·å¼€å±•ä¸šåŠ¡ã€‚",
        ...
    }

    ```
## 3 æ¡ˆä¾‹å…¥åº“
### 3.1 ESå‡†å¤‡
æˆ‘ä½¿ç”¨çš„æ˜¯ElasticSearch-9.2.2åšçŸ¥è¯†å­˜å‚¨ï¼Œé¡¹ç›®æ‰§è¡Œå‰éœ€å…ˆå¯åŠ¨çŸ¥è¯†åº“ã€‚
- åœ¨```elasticsearch-9.2.2/bin```ç›®å½•ï¼ŒåŒå‡»```elasticsearch.bat```è¿›è¡Œå¯åŠ¨ã€‚
  - å¦‚æœæŠ¥é”™ï¼Œè¯·ç¡®è®¤æ–‡ä»¶å¤¹è·¯å¾„æ— ç©ºæ ¼ã€‚
  - è¿˜ä¸è¡Œä¿®æ”¹```elasticsearch-9.2.2/config/elasticsearch.yml```ï¼Œè®¾ç½®```xpack.security.enabled: false```å…³é—­å®‰å…¨è®¾ç½®ã€‚
- å®‰è£…æˆåŠŸåè¿è¡Œå¯è§
    ```
    {
    "name" : "your pc name",
    "cluster_name" : "elasticsearch",
    "cluster_uuid" : "xxxxxxxxxxxxxx",
    "version" : {
        "number" : "9.2.2",
        "build_flavor" : "default",
        "build_type" : "zip",
        "build_hash" : "xxxxxxxxxxxxxx",
        "build_date" : "2025-xx-xxT08:06:51.614397514Z",
        "build_snapshot" : false,
        "lucene_version" : "10.3.2",
        "minimum_wire_compatibility_version" : "8.19.0",
        "minimum_index_compatibility_version" : "8.0.0"
    },
    "tagline" : "You Know, for Search"
    }
    ```

### 3.2 ç”Ÿæˆæ¡ˆä¾‹
```
python ./make_case/case_create.py
```
ç”¨å¤§æ¨¡å‹ç”Ÿæˆäº†ä¸€æ‰¹ï¼Œè§```./data/ä¿é™©è¡Œä¸šå®¡è®¡ç¼ºé™·æ¡ˆä¾‹æ•°æ®é›†.xlsx```
| å‘ç”Ÿæ—¶é—´   | çœ     | å¸‚     | å­å…¬å¸ | åˆ†æ”¯ç»“æ„ | ç¼ºé™·å†…å®¹                                                                   |
| ---------- | ------ | ------ | ------ | -------- | -------------------------------------------------------------------------- |
| 2023-09-14 | æµ™æ±Ÿçœ | æ­å·å¸‚ | å¥åº·é™© | ä½™æ­åŒº   | åŒ»ç–—é™©ç†èµ”æ¡£æ¡ˆæœªå½’æ¡£ï¼Œ34ç¬”2023å¹´ç†èµ”æ¡ˆæœªåœ¨30å¤©å†…å½’æ¡£ï¼Œè¿åæ¡£æ¡ˆç®¡ç†è§„å®š     |
| 2023-10-21 | æ¹–åŒ—çœ | è¥„é˜³å¸‚ | å¯¿é™©   | æ­¦æ˜ŒåŒº   | é‡ç–¾é™©ç†èµ”æœªå®¡æ ¸æ²»ç–—è®°å½•ï¼Œ16ç¬”ç†èµ”æ¡ˆæ— å®Œæ•´æ²»ç–—ç—…å†ï¼Œå­˜åœ¨è™šå‡ç†èµ”é£é™©       |
| 2023-03-07 | å¹¿ä¸œçœ | ç æµ·å¸‚ | äº§é™©   | å®å®‰åŒº   | å†œä¸šé™©æ‰¿ä¿æœªæ ¸å®æŠ•ä¿æ ‡çš„æ•°é‡ï¼Œ27ç¬”å†œé™©ä¿å•å­˜åœ¨è™šå¢ç§æ¤é¢ç§¯ï¼Œæ¶‰ä¿è´¹12.8ä¸‡å…ƒ |

### 3.3 ESå†™å…¥æ¡ˆä¾‹
```
python ./make_case/es_write.py
```
ä»£ç å†…ä¸»è¦æ­¥éª¤è¯´æ˜ï¼š

#### 3.3.1 åˆ›å»ºESç´¢å¼•
```
index_mapping = {
    "mappings": {
        "properties": {
            "å‘ç”Ÿæ—¶é—´": {
                "type": "date",
                "format": "yyyy-MM-dd||yyyy-MM-dd HH:mm:ss||epoch_millis",
            },
            "çœ": {"type": "keyword"},
            "å¸‚": {"type": "keyword"},
            "å­å…¬å¸": {"type": "keyword"},
            "åˆ†æ”¯ç»“æ„": {"type": "keyword"},
            "ç¼ºé™·å†…å®¹": {"type": "text"},
        }
    }
}
```
#### 3.3.2 å®šä¹‰ç´¢å¼•åç§°å¹¶å†™å…¥
```
def create_index(index_name):
    if not es.indices.exists(index=index_name):
        es.indices.create(index=index_name, body=index_mapping)
        print(f"âœ… ç´¢å¼• {index_name} åˆ›å»ºæˆåŠŸ")
    else:
        print(f"ç´¢å¼• {index_name} å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤åˆ›å»ºã€‚")


index_name = "audit_2025_cases"
create_index(index_name)
```
#### 3.3.3 è¯»å–æ•°æ®è½¬ä¸ºESå†™å…¥æ ¼å¼
```
from elasticsearch.helpers import bulk

# æ ¼å¼åŒ–æ•°æ®ä¸º ES Bulk è¦æ±‚çš„æ ¼å¼
def format_es_actions(df, index_name):
    ...

    return actions


# 2.3 ç”Ÿæˆæ‰¹é‡å†™å…¥æ•°æ®
es_actions = format_es_actions(df, index_name)
print(f"âœ… ç”Ÿæˆ {len(es_actions)} æ¡ ES å†™å…¥æ•°æ®")
```
#### 3.3.4 æ‰¹é‡å†™å…¥ES
```
def bulk_write_to_es(client=es, actions=es_actions):
    try:
        # æ‰¹é‡å†™å…¥ï¼ˆchunk_sizeï¼šæ¯æ‰¹å†™å…¥æ¡æ•°ï¼Œmax_retriesï¼šå¤±è´¥é‡è¯•æ¬¡æ•°ï¼‰
        success, failed = bulk(
            client,
            actions,
            chunk_size=100,  # æ¯æ‰¹ 100 æ¡ï¼ˆæ ¹æ® ES æ€§èƒ½è°ƒæ•´ï¼Œå»ºè®® 500-2000ï¼‰
            max_retries=3,  # å¤±è´¥é‡è¯• 3 æ¬¡
        )
        print(f"âœ… ES æ‰¹é‡å†™å…¥æˆåŠŸï¼š{success} æ¡")
        if failed:
            print(f"âŒ å†™å…¥å¤±è´¥ï¼š{len(failed)} æ¡ï¼Œå¤±è´¥è¯¦æƒ…ï¼š{failed}")
    except Exception as e:
        print(f"âŒ ES å†™å…¥å¼‚å¸¸ï¼š{str(e)}")


# æ‰§è¡Œæ‰¹é‡å†™å…¥
bulk_write_to_es(es, es_actions)
```
#### 3.3.5 æ£€æŸ¥ESæ•°æ®
```
# æŸ¥æŸ¥æ€»æ•°
count_resp = es.count(index=index_name)
print("æ–‡æ¡£æ€»æ•°ï¼š", count_resp)

# çœ‹å‡ æ¡æ ·ä¾‹
search_resp = es.search(index=index_name, body={"size": 2, "query": {"match_all": {}}})
print("ç¤ºä¾‹æ–‡æ¡£ï¼š")
for hit in search_resp["hits"]["hits"]:
    print(hit["_source"])
```
#### 3.3.6 æ›´æ–°ESå‘é‡åŒ–ç´¢å¼•å­—æ®µ
```
mapping_update = {
    "properties": {"ç¼ºé™·å†…å®¹å‘é‡_qwen": {"type": "dense_vector", "dims": 1024}}
}

# æ‰§è¡Œç»“æ„æ›´æ–°
resp = es.indices.put_mapping(index=index_name, body=mapping_update)
print("mapping æ›´æ–°ç»“æœï¼š", resp)
```
#### 3.3.7 æ¡ˆä¾‹å‘é‡åŒ–
è°ƒç”¨å…¬ç½‘åµŒå…¥æ¨¡å‹è¿›è¡Œå‘é‡åŒ–ï¼Œè¯·ä¿®æ”¹ä¸ºè‡ªå·±çš„urlå’Œapi_key
```
client = AsyncOpenAI(
    base_url="your_base_url",
    api_key="your_api_key",
)

async def process_single_case(case: str) -> dict:
    completion = await client.embeddings.create(
        model="text-embedding-v3", input=case, dimensions=1024
    )
    return completion.data[0].embedding
```

#### 3.3.8 æ‰¹é‡å‘é‡åŒ–å†™å…¥ES
```
updater = ESUpdater(
    es_client=es,
    index_name=index_name,
    embedding_func=process_batch_cases,
    vector_field="ç¼ºé™·å†…å®¹å‘é‡_qwen",  # ä¸ES mappingä¸­å®šä¹‰çš„å‘é‡å­—æ®µåä¸€è‡´
)

# æ‰§è¡Œæ›´æ–°
asyncio.run(updater.batch_update_vectors())
```

#### 3.3.9 æ£€æŸ¥å‘é‡åŒ–æ›´æ–°æƒ…å†µ
```
# æ£€æŸ¥æ›´æ–°æƒ…å†µ
search_resp = es.search(
    index=index_name,
    body={
        "size": 2,
        "_source": ["ç¼ºé™·å†…å®¹", "ç¼ºé™·å†…å®¹å‘é‡_qwen"],
        "query": {"match_all": {}},
    },
)
print("ç¤ºä¾‹æ–‡æ¡£ï¼š")
for hit in search_resp["hits"]["hits"]:
    print(
        hit["_source"].get("ç¼ºé™·å†…å®¹", ""),
        hit["_source"].get("ç¼ºé™·å†…å®¹å‘é‡_qwen", "")[:4],
    )
```
## 4 æ­å»ºå¤šè½®é—®ç­”æœºå™¨äºº
åŸºäºlanggraphæ­å»ºå¤šè½®é—®ç­”æœºå™¨äººï¼Œä¸»è¦åŒ…æ‹¬æŒ‡ä»¤ç†è§£ï¼ˆæ‹’ç­”åˆ¤æ–­ã€è¿½é—®åˆ¤æ–­ã€æ„å›¾è¯†åˆ«ã€æœ¯è¯­è¯†åˆ«ã€æŒ‡ä»¤æ”¹å†™ï¼‰ã€ä¿¡æ¯æ£€ç´¢ã€æ¡ˆä¾‹åˆ†æï¼Œæ ¸å¿ƒåœ¨äº**æ¨¡å—é—´çš„æµè½¬**å’Œ**ä¸Šä¸‹æ–‡è®°å¿†**ã€‚
å¯ä»¥ç›´æ¥è¿è¡Œ```python Case_QA.py```

### 4.1 é…ç½®é¡¹å‡†å¤‡
ä¸»è¦åŒ…æ‹¬ESåº“è¯»å–ã€å¤§æ¨¡å‹è°ƒç”¨ã€åµŒå…¥è°ƒç”¨ï¼ˆæŠŠç”¨æˆ·æŸ¥è¯¢è½¬ä¸ºå‘é‡ï¼‰
```
# ESé…ç½®é¡¹ï¼Œåœ°å€ã€æ¥å£ã€ä»“åº“
ES_HOST = "http://localhost:9200"
es = Elasticsearch(f"{ES_HOST}")
index_name = "audit_2025_cases"

# OpenAIçš„embeddingæ¥å£
client = OpenAI(
    base_url="your_base_url",
    api_key="your_api_key",
)

# æ–‡æœ¬è½¬å‘é‡
def text2vec(case: str) -> dict:
    completion = client.embeddings.create(
        model="text-embedding-v3", input=case, dimensions=1024
    )
    return completion.data[0].embedding

# å¤§æ¨¡å‹æ¥å£
llm = ChatOpenAI(
    model="qwen-plus",
    openai_api_key="your_api_key",
    openai_api_base="your_base_url",
)
```
### 4.2 å®šä¹‰agentçŠ¶æ€
ä¸€ä¸ªæ˜¯ä¸ç”¨ä¿®æ”¹çš„ï¼Œå¦‚ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ã€æ£€ç´¢çš„é…ç½®ç­‰ã€‚ä¸€ä¸ªæ˜¯éœ€è¦æ›´æ–°çš„agentå¯¹è¯çŠ¶æ€ç®¡ç†ã€‚
```
# å›ºåŒ–ä¿¡æ¯
class Ctx(TypedDict):
    user_name: str
    user_province: str = ""
    user_city: str = ""
    user_district: str = ""
    user_subcompany: str = ""
    topk: int = 3
    threshold: float = 0.0

# çŠ¶æ€ä¿¡æ¯
class State(TypedDict):
    messages: Annotated[list, add_messages]
    memory: list
    query: str
    reject: str
    ask_further: str
    query_rewrite: str
    cases: list
    response: str
```

### 4.3 æ‹’ç­”æ¨¡å—
è¿™ä¸ªæ¨¡å—æ˜¯è¾“å…¥å†å²ä¸Šä¸‹æ–‡+æœ¬è½®ç”¨æˆ·é—®é¢˜ï¼Œåˆ¤æ–­æ˜¯å¦æ‹’ç­”ã€‚**é‡ç‚¹æ˜¯éœ€è¦åœ¨messageä¸­å‰”é™¤æ‰æœ¬è½®è®°å½•ï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å—æ˜¯ä¸€æ¬¡æ€§çš„ä¸­é—´ä¿¡æ¯ä¸å±äºä¸Šä¸‹æ–‡**ã€‚ç„¶åé€šè¿‡è·¯ç”±åˆ†æµï¼Œæ‹’ç­”ç›´æ¥ç»“æŸï¼Œä¸æ‹’ç­”å°±åˆ°ä¸‹ä¸€ä¸ªè¿½é—®åˆ¤æ–­ã€‚
```
# æ‹’ç­”åˆ¤æ–­
def reject(state: State):
    ...
    return {"reject": response.content}

# è·¯ç”±æ¨¡å—
def should_analyse(state: State):
    if "å›ç­”" in state["reject"]:
        return "å›ç­”"
    else:
        ...
        state["response"] = "å¾ˆæŠ±æ­‰ï¼Œè¿™ä¸ªé—®é¢˜ä¸æ˜¯å®¡è®¡æ¡ˆä¾‹ç›¸å…³é—®é¢˜ï¼Œæˆ‘ä¸ä½œå›ç­”ã€‚"

        return "æ‹’ç­”"
```

### 4.4 è¿½é—®æ¨¡å—
è¿™ä¸ªæ¨¡å—æ˜¯è¾“å…¥å†å²ä¸Šä¸‹æ–‡+æœ¬è½®ç”¨æˆ·é—®é¢˜ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯è¿½é—®ã€‚è¿™ä¸ªæ¨¡å—çš„ä½œç”¨æ˜¯åˆ¤æ–­æ˜¯å¦ä¸ºå•çº¯çš„è¿½é—®è€Œä¸éœ€è¦è°ƒESæ£€ç´¢ï¼Œ**éœ€è¦åœ¨messageä¸­å‰”é™¤æ‰æœ¬è½®è®°å½•ï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å—æ˜¯ä¸€æ¬¡æ€§çš„ä¸­é—´ä¿¡æ¯ä¸å±äºä¸Šä¸‹æ–‡**ã€‚ç„¶åé€šè¿‡è·¯ç”±åˆ†æµï¼Œè¿½é—®çš„ç›´æ¥åˆ°åˆ†æï¼Œä¸æ˜¯è¿½é—®çš„å°±åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤æ”¹å†™ã€‚
```
# è¿½é—®åˆ¤æ–­
def ask_further(state: State):
    ...
    return {"ask_further": new_or_old}

# è·¯ç”±æ¨¡å—
def should_es_search(state: State):
    ...

    if "æ˜¯" in state["ask_further"]:
        return "æ˜¯"
    else:
        return "å¦"
```

### 4.5 æŒ‡ä»¤æ”¹å†™æ¨¡å—
è¿™ä¸ªæ¨¡å—ä¼šå…ˆå¯¹ç”¨æˆ·æŸ¥è¯¢ï¼Œæ ¹æ®è§„åˆ™åŒ¹é…å‡ºæåŠçš„ä¸“ä¸šæœ¯è¯­å’Œæ¨¡ç³Šè¡¨è¿°ã€‚ç„¶åç»“åˆä¸Šä¸‹æ–‡ã€æœ¯è¯­æŸ¥è¯¢ç»“æœï¼Œå°†é—®é¢˜æ”¹å†™ä¸ºä¸€ä¸ªä¿¡æ¯å…¨é¢çš„é—®é¢˜ï¼Œä½œä¸ºåç»­çš„æ–°ç”¨æˆ·æŸ¥è¯¢ã€‚å³ill-definedåˆ°well-definedã€‚
```
def rewrite(state: State):
    ...
    return {"query_rewrite": query_rewrite}
```

### 4.6 ESæ£€ç´¢æ¨¡å—
è¿™ä¸ªæ¨¡å—ä¼šæ ¹æ®ç”¨æˆ·æƒé™åšè§„åˆ™ç­›é€‰ï¼Œç­›é€‰å‡ºç¬¦åˆæƒé™çš„æ¡ˆä¾‹ã€‚ç„¶åæ ¹æ®æŸ¥è¯¢æ”¹å†™å’Œæ¡ˆä¾‹å‘é‡ç›¸ä¼¼åº¦ï¼Œåšè¯­ä¹‰åŒ¹é…å¬å›topkä¸ªæ¡ˆä¾‹ã€‚
```
def es_search(state: State):
    ...
    return {"cases": cases}
```

### 4.7 æ¡ˆä¾‹åˆ†ææ¨¡å—
è¿™ä¸ªæ¨¡å—ä¼šè¾“å…¥å†å²ä¸Šä¸‹æ–‡ã€æŸ¥è¯¢æ”¹å†™å’Œæ¡ˆä¾‹ï¼Œè®©å¤§æ¨¡å‹è¿›è¡Œåˆ†æä½œç­”ã€‚
```
def analyse(state: State):
    ...
    return {"response": response.content}
```

### 4.8 æ„å»ºlanggraphé™æ€å›¾
æ ¹æ®æ¯ä¸ªæ¨¡å—çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±æ¯”è¾ƒæ¸…æ™°çš„æ„å»ºå‡ºé™æ€å›¾ã€‚

```
# å»ºç«‹é™æ€å›¾
graph = StateGraph(State)
graph.add_node("æ‹’ç­”åˆ¤æ–­", reject)
graph.add_node("è¿½é—®åˆ¤æ–­", ask_further)
graph.add_node("æŒ‡ä»¤æ”¹å†™", rewrite)
graph.add_node("æ¡ˆä¾‹æ£€ç´¢", es_search)
graph.add_node("åˆ†æå›ç­”", analyse)
graph.add_edge(START, "æ‹’ç­”åˆ¤æ–­")
graph.add_conditional_edges(
    "æ‹’ç­”åˆ¤æ–­", should_analyse, {"æ‹’ç­”": END, "å›ç­”": "è¿½é—®åˆ¤æ–­"}
)
graph.add_conditional_edges(
    "è¿½é—®åˆ¤æ–­", should_es_search, {"æ˜¯": "åˆ†æå›ç­”", "å¦": "æŒ‡ä»¤æ”¹å†™"}
)
graph.add_edge("æŒ‡ä»¤æ”¹å†™", "æ¡ˆä¾‹æ£€ç´¢")
graph.add_edge("æ¡ˆä¾‹æ£€ç´¢", "åˆ†æå›ç­”")
graph.add_edge("åˆ†æå›ç­”", END)

# ç¼–è¯‘é™æ€å›¾
app = graph.compile()
# ç²—ç•¥å¯è§†åŒ–
app.get_graph().print_ascii()
              +-----------+
              | __start__ |
              +-----------+
                    *
                    *
                    *
                +------+
                | æ‹’ç­”åˆ¤æ–­ |.
                +------+ ..
                .          ...
              ..              ...
             .                   ..
        +------+                   ..
        | è¿½é—®åˆ¤æ–­ |                    .
        +------+                    .
        .       .                   .
      ..         .                  .
     .            ..                .
+------+            .               .
| æŒ‡ä»¤æ”¹å†™ |            .               .
+------+            .               .
+------+            .               .
+------+            .               .
    *               .               .
    *               .               .
    *               .               .
    *               .               .
    *               .               .
+------+            .               .
| æ¡ˆä¾‹æ£€ç´¢ |          ..                .
+------+         .                  .
        *       .                   .
         **   ..                    .
           * .                      .
        +------+                   ..
        | åˆ†æå›ç­” |                 ..
        +------+              ...
                *          ...
                 **      ..
                   *   ..
              +---------+
              | __end__ |
              +---------+
```

## 5 å®é™…æ•ˆæœ

### å›ºå®šä¿¡æ¯
```
context = {
    "user_province": "å±±ä¸œçœ",
    "user_city": "",
    "user_district": "",
    "user_subcompany": "äº§é™©",
    "topk": 3,
    "threshold": 0.0,
}
```

### çŠ¶æ€æ›´æ–°
langgraphè‡ªå¸¦çš„MemorySaveä»…æ”¯æŒstateå†…éƒ¨åªæœ‰messageï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸€è½®è‡ªå·±ç»´æŠ¤å¥½stateä¼ è¿›å»ï¼ˆä»…éœ€æ›´æ–°å½“å‰stateçš„queryï¼‰ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å°†stateä»¥jsonçš„æ ¼å¼ä¿å­˜æ¥é•¿æœŸå›ºåŒ–ã€‚

### é—®ç­”æ•ˆæœ
ğŸ¤– æœºå™¨äººï¼šä½ å¥½å‘€ï¼

ğŸ‘¤ ä½ : è¯·å¸®æˆ‘æŸ¥ä¸€ä¸‹å†œé™©è¿‘æœŸç¼ºé™·æ¡ˆä¾‹æœ‰å“ªäº›ï¼Ÿ

ğŸ‘‰æ˜¯å¦æ‹’ç­”ï¼šå›ç­”

ğŸ‘‰æ˜¯å¦è¿½é—®ï¼šå¦

ğŸ‘‰æŒ‡ä»¤æ”¹å†™ï¼šè¯·å¸®æˆ‘æŸ¥è¯¢è¿‘ä¸‰ä¸ªæœˆå†…å†œä¸šä¿é™©ç›¸å…³çš„ç¼ºé™·æ¡ˆä¾‹æœ‰å“ªäº›ï¼Ÿ

ğŸ‘‰ESæœç´¢ç»“æœï¼š
{'took': 16, 'timed_out': False, '_shards': {'total': 1, 'successful': 1, 'skipped': 0, 'failed': 0}, 'hits': {'total': {'value': 10, 'relation': 'eq'}, 'max_score': 0.7024403, 'hits': [{'_index': 'audit_2025_cases', '_id': '25', '_score': 0.7024403, '_source': {'çœ': 'å±±ä¸œçœ', 'å¸‚': 'æ½åŠå¸‚', 'å­å…¬å¸': 'äº§é™©', 'ç¼ºé™·å†…å®¹': 'å†œä¸šé™©ç†èµ”æœªå…¬ç¤ºæŸå¤±ä¿¡æ¯ï¼Œ22ç¬”å†œé™©ç† èµ”æœªæŒ‰è¦æ±‚åœ¨æ‘ç¤¾å…¬ç¤ºï¼Œè¿åå†œé™©ç›‘ç®¡è§„å®š'}}, {'_index': 'audit_2025_cases', '_id': '270', '_score': 0.6900946, '_source': {'çœ': 'å±±ä¸œçœ', 'å¸‚': 'æ·„åšå¸‚', 'å­å…¬å¸': 'äº§é™©', 'ç¼ºé™·å†…å®¹': 'å†œä¸šé™©æ‰¿ä¿æœªç­¾è®¢æ­£å¼æŠ•ä¿åè®®ï¼Œ19ç¬”ä¿å•ä»…å£å¤´çº¦å®šï¼Œæ— ä¹¦é¢åè®®ï¼Œè¿åæ‰¿ä¿æµç¨‹'}}, {'_index': 'audit_2025_cases', '_id': '263', '_score': 0.6629813, '_source': {'çœ': 'å±±ä¸œçœ', 'å¸‚': 'æ·„åšå¸‚', 'å­å…¬å¸': 'äº§é™©', 'ç¼ºé™·å†…å®¹': 'çŸ­æœŸæ„å¤–é™©ï¼ˆäº§é™©ï¼‰é”€å”®æœªæç¤ºå…è´£æ¡æ¬¾ï¼Œ35åå®¢æˆ·å› æœªçŸ¥æ™“å…è´£æ‹’èµ”æŠ•è¯‰ï¼Œè¿åé”€å”®è§„èŒƒ'}}]}}

ğŸ¤– æœºå™¨äººï¼šæ ¹æ®æ‚¨æä¾›çš„æ¡ˆä¾‹ä¿¡æ¯ï¼Œè¿‘ä¸‰ä¸ªæœˆå†…ä¸å†œä¸šä¿é™©ç›¸å…³çš„ç¼ºé™·æ¡ˆä¾‹æœ‰ä»¥ä¸‹ä¸¤èµ·ï¼š

1. **å±±ä¸œçœæ½åŠå¸‚**ï¼ˆå­å…¬å¸ï¼šäº§é™©ï¼‰
   ç¼ºé™·å†…å®¹ï¼šå†œä¸šé™©ç†èµ”æœªå…¬ç¤ºæŸå¤±ä¿¡æ¯ã€‚å…±å‘ç°22ç¬”å†œé™©ç†èµ”æœªæŒ‰ç›‘ç®¡è¦æ±‚åœ¨æ‘ç¤¾è¿›è¡Œå…¬ç¤ºï¼Œè¿åäº†å†œä¸šä¿é™©çš„ç›¸å…³ç›‘ç®¡è§„å®šã€‚      

2. **å±±ä¸œçœæ·„åšå¸‚**ï¼ˆå­å…¬å¸ï¼šäº§é™©ï¼‰
   ç¼ºé™·å†…å®¹ï¼šå†œä¸šé™©æ‰¿ä¿æœªç­¾è®¢æ­£å¼æŠ•ä¿åè®®ã€‚æ¶‰åŠ19ç¬”ä¿å•ï¼Œä»…é€šè¿‡å£å¤´çº¦å®šå®Œæˆæ‰¿ä¿ï¼Œç¼ºä¹ä¹¦é¢æŠ•ä¿åè®®ï¼Œè¿åäº†å†œä¸šä¿é™©çš„æ‰¿ä¿æµç¨‹è§„èŒƒã€‚

ä»¥ä¸Šæ¡ˆä¾‹å‡æ¶‰åŠå†œä¸šä¿é™©åœ¨æ‰¿ä¿æˆ–ç†èµ”ç¯èŠ‚çš„æ“ä½œä¸åˆè§„é—®é¢˜ï¼Œåæ˜ å‡ºåœ¨ä¿¡æ¯æŠ«éœ²å’Œæµç¨‹è§„èŒƒåŒ–æ–¹é¢å­˜åœ¨è–„å¼±ç¯èŠ‚ã€‚

ğŸ‘¤ ä½ : è¿™äº›æ¡ˆä¾‹éƒ½æ˜¯å“ªä¸ªå¸‚çš„ï¼Ÿ

ğŸ‘‰æ˜¯å¦æ‹’ç­”ï¼šå›ç­”

ğŸ‘‰æ˜¯å¦è¿½é—®ï¼šæ˜¯

ğŸ¤– æœºå™¨äººï¼šè¿™äº›å†œä¸šä¿é™©ç›¸å…³çš„ç¼ºé™·æ¡ˆä¾‹åˆ†åˆ«æ¶‰åŠä»¥ä¸‹ä¸¤ä¸ªå¸‚ï¼š

- **æ½åŠå¸‚**
- **æ·„åšå¸‚**

å…¶ä¸­ï¼Œæ½åŠå¸‚å’Œæ·„åšå¸‚å‡å±äºå±±ä¸œçœã€‚

## 6 åç»­ä¼˜åŒ–æ–¹å‘
- ä¸ºäº†ç¡®ä¿æ£€ç´¢æ•ˆæœï¼Œç›®å‰æ˜¯åŸºäºESæ¨¡æ¿ï¼ŒæŸ¥è¯¢ç±»å‹æ¯”è¾ƒæœ‰é™ã€‚åç»­åº”é€šè¿‡æŒ‡ä»¤æ›´ç»†è‡´çš„ç†è§£ï¼Œè®©å¤§æ¨¡å‹è‡ªä¸»æ’°å†™ESæŸ¥è¯¢ä»£ç å¹¶æ‰§è¡Œï¼›
- ç¼ºä¹é—­ç¯è¿­ä»£ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªåæ€éªŒè¯æ¨¡å—ï¼Œé’ˆå¯¹å½“å‰æ¨¡å—è°ƒç”¨å¤±è´¥ã€æ‰§è¡Œä¸å¥½çš„ï¼Œéœ€è¦é‡å¤æ‰§è¡Œï¼›
- è€ƒè™‘åˆ°ä¸šåŠ¡æµç¨‹å¯æ§ï¼Œç›®å‰åªèƒ½ç®—æ˜¯ä¸€ä¸ªå¸¦æœ‰åˆ†æ”¯çš„å·¥ä½œæµã€‚åç»­å¯ä»¥è€ƒè™‘æŠŠæ¯ä¸ªæ¨¡å—å°è£…ä¸ºmcpå·¥å…·æ¥è°ƒç”¨ï¼ŒçœŸæ­£çš„å®ç°plan-action-verifyçš„è‡ªä¸»æ€è€ƒagentï¼›